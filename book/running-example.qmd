---
title: "Running example (M1): SEIR + reporting"
---

This page executes a minimal deterministic **SEIR + reporting** pipeline using the companion Python package.

Scope (M1 slice):

- Deterministic SEIR simulation (Euler discretisation).
- A paired **stochastic** SEIR variant (tau-leaping; non-differentiable).
- An observation model: incidence derived from the drop in susceptibles, then **reported cases** via under-reporting, a delay distribution, and NB noise.
- A tiny paired pipeline that produces `TimeSeriesDataset` objects for both deterministic and stochastic simulations.

Assumptions / parameterisation:

- Compartments are continuous (real-valued) and **closed**: births/deaths are ignored, so total population is conserved.
- `beta` is the effective transmission rate, `sigma = 1 / latent_period`, `gamma = 1 / infectious_period`.
- The solver is a simple **forward Euler** discretisation with step size `dt` (smaller `dt` is more stable).

Observation model (per time step):

- Incidence: $i_t = \max(S_t - S_{t+1}, 0)$
- Under-reporting: $\tilde{i}_t = \rho\, i_t$
- Delay: $\mu_t = \sum_{d\ge 0} \tilde{i}_{t-d} w_d$, where $w_d$ is a discrete delay PMF.
- Noise: $y_t \sim \text{NegBin}(\mu_t, \kappa)$ with $\mathrm{Var}(y_t)=\mu_t + \mu_t^2/\kappa$.

```{python}
import numpy as np
import matplotlib.pyplot as plt

from diff_epi_inference import (
    SEIRParams,
    TimeSeriesDataset,
    discrete_gamma_delay_pmf,
    expected_reported_cases_delayed,
    incidence_from_susceptibles,
    nbinom_loglik,
    sample_nbinom_reports,
    simulate_seir_and_report_deterministic,
    simulate_seir_and_report_stochastic,
    simulate_seir_euler,
)

params = SEIRParams(beta=0.6, sigma=1/5, gamma=1/7)
out = simulate_seir_euler(
    params=params,
    s0=999.0,
    e0=0.0,
    i0=1.0,
    r0=0.0,
    dt=0.2,
    steps=200,
)

t = out["t"]
S, E, I, R = out["S"], out["E"], out["I"], out["R"]

fig, ax = plt.subplots(figsize=(7, 4))
ax.plot(t, S, label="S")
ax.plot(t, E, label="E")
ax.plot(t, I, label="I")
ax.plot(t, R, label="R")
ax.set_xlabel("time")
ax.set_ylabel("population")
ax.set_title("SEIR (Euler discretisation)")
ax.legend()
plt.show()

# Basic invariant check
assert np.allclose(S + E + I + R, S[0] + E[0] + I[0] + R[0])

# --- Observation / reporting model ---

# Incidence per step is derived from the drop in susceptibles.
inc = incidence_from_susceptibles(S)

# A slightly richer model than rho * incidence:
#   1) under-reporting via rho
#   2) a reporting delay distribution w_d
#   3) negative binomial observation noise (over-dispersion)

rho = 0.3
w = discrete_gamma_delay_pmf(shape=2.0, scale=1.0, max_delay=20)
mu = expected_reported_cases_delayed(incidence=inc, reporting_rate=rho, delay_pmf=w)

dispersion = 20.0
rng = np.random.default_rng(0)
y = sample_nbinom_reports(expected=mu, dispersion=dispersion, rng=rng)
ll = nbinom_loglik(y=y, mu=mu, dispersion=dispersion)

ds_det = TimeSeriesDataset(t=t[1:], y=y, name="reported (deterministic)")

fig, ax = plt.subplots(figsize=(7, 3))
ax.plot(ds_det.t, mu, label="E[reported] (delay + rho)")
ax.plot(ds_det.t, ds_det.y, label=ds_det.name, alpha=0.7)
ax.set_xlabel("time")
ax.set_ylabel("cases / step")
ax.set_title("Observation model")
ax.legend()
plt.show()

assert np.isfinite(ll)
assert inc.shape == mu.shape == ds_det.y.shape

# --- Paired deterministic vs stochastic pipelines ---

ds_det2 = simulate_seir_and_report_deterministic(
    params=params,
    s0=999.0,
    e0=0.0,
    i0=1.0,
    r0=0.0,
    dt=0.2,
    steps=200,
    reporting_rate=rho,
    rng=np.random.default_rng(1),
    name="reported (det pipeline)",
)

ds_sto2 = simulate_seir_and_report_stochastic(
    params=params,
    s0=999,
    e0=0,
    i0=1,
    r0=0,
    dt=0.2,
    steps=200,
    reporting_rate=rho,
    rng=np.random.default_rng(2),
    name="reported (stoch pipeline)",
)

fig, ax = plt.subplots(figsize=(7, 3))
ax.plot(ds_det2.t, ds_det2.y, label=ds_det2.name)
ax.plot(ds_sto2.t, ds_sto2.y, label=ds_sto2.name, alpha=0.8)
ax.set_xlabel("time")
ax.set_ylabel("cases / step")
ax.set_title("Paired deterministic vs stochastic reported cases")
ax.legend()
plt.show()

assert ds_det2.t.shape == ds_det2.y.shape == ds_sto2.t.shape == ds_sto2.y.shape
```
